#!/bin/bash

# ุงุณฺฉุฑูพุช ุชูุธู ุงููู ุณุณุชู ุจฺฉุงูพ

echo "๐ง ุชูุธู ุณุณุชู ุจฺฉุงูพ ุฏุชุงุจุณ..."

# 1. ุณุงุฎุช ูพูุดู data
echo "๐ ุณุงุฎุช ูพูุดู data..."
mkdir -p ./data
chmod 755 ./data

# 2. ุณุงุฎุช ูพูุดู ุจฺฉุงูพ
echo "๐ ุณุงุฎุช ูพูุดู ุจฺฉุงูพ..."
mkdir -p /root/backups/installment-db
chmod 755 /root/backups/installment-db

# 3. ุงุฌุงุฒู ุงุฌุฑุง ุจู ุงุณฺฉุฑูพุชโูุง
echo "๐ ุชูุธู ุฏุณุชุฑุณโูุง..."
chmod +x backup.sh restore.sh

# 4. ุชุณุช ุจฺฉุงูพ
echo "๐งช ุชุณุช ุจฺฉุงูพ..."
if [ -f "./data/installment_business.db" ]; then
    ./backup.sh
    echo "โ ุจฺฉุงูพ ุงููู ุจุง ููููุช ุงูุฌุงู ุดุฏ"
else
    echo "โ๏ธ  ุฏุชุงุจุณ ูููุฒ ุณุงุฎุชู ูุดุฏู. ุจุนุฏ ุงุฒ ุงููู ุงุฌุฑุงุ ุจฺฉุงูพ ฺฏุฑูุชู ูุดู."
fi

# 5. ุชูุธู cron
echo "โฐ ุชูุธู ุจฺฉุงูพ ุฎูุฏฺฉุงุฑ..."
CRON_JOB="0 2 * * * cd $(pwd) && ./backup.sh >> /var/log/db-backup.log 2>&1"

# ฺฺฉ ฺฉุฑุฏู ุงูฺฉู cron job ูุจูุง ุงุถุงูู ูุดุฏู ุจุงุดู
if ! crontab -l 2>/dev/null | grep -q "backup.sh"; then
    (crontab -l 2>/dev/null; echo "$CRON_JOB") | crontab -
    echo "โ ุจฺฉุงูพ ุฎูุฏฺฉุงุฑ ุฑูุฒุงูู (ุณุงุนุช 2 ุตุจุญ) ุชูุธู ุดุฏ"
else
    echo "โน๏ธ  ุจฺฉุงูพ ุฎูุฏฺฉุงุฑ ูุจูุง ุชูุธู ุดุฏู"
fi

# 6. ููุงุด ูุถุนุช
echo ""
echo "โ ุชูุธูุงุช ฺฉุงูู ุดุฏ!"
echo ""
echo "๐ ูุถุนุช:"
echo "  - ูพูุดู ุฏุชุงุจุณ: ./data/"
echo "  - ูพูุดู ุจฺฉุงูพ: /root/backups/installment-db/"
echo "  - ุจฺฉุงูพ ุฎูุฏฺฉุงุฑ: ุฑูุฒุงูู ุณุงุนุช 2 ุตุจุญ"
echo "  - ูฺฏูุฏุงุฑ ุจฺฉุงูพ: 30 ุฑูุฒ"
echo ""
echo "๐ ุฏุณุชูุฑุงุช ููุฏ:"
echo "  - ุจฺฉุงูพ ุฏุณุช: ./backup.sh"
echo "  - ุจุงุฒุงุจ: ./restore.sh"
echo "  - ูุดุงูุฏู ุจฺฉุงูพโูุง: ls -lh /root/backups/installment-db/"
echo "  - ูุดุงูุฏู ูุงฺฏ: tail -f /var/log/db-backup.log"
