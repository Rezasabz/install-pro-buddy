# سیستم محاسبه سود شرکا بر اساس زمان ورود و خروج

## منطق سیستم

شرکا فقط از زمان ورودشان تا زمان خروجشان سهم سود دارند. این یعنی:

1. **شریک جدید فقط از زمان ورودش سهم سود می‌گیرد**
2. **سودهای قبل از ورود شریک جدید متعلق به شرکای قبلی است**
3. **شریک حذف شده فقط تا زمان حذفش سهم سود دارد**
4. **سهم هر شریک بر اساس سرمایه‌اش در زمان هر فروش/قسط محاسبه می‌شود**
5. **حذف شریک به صورت Soft Delete انجام می‌شه (غیرفعال می‌شه)**

## مثال عملی

### مرحله 1: شرکای اولیه
- **علی**: 10 میلیون تومان (1 فروردین 1403)
- **حسن**: 5 میلیون تومان (1 فروردین 1403)
- **مجموع سرمایه**: 15 میلیون تومان

**سهم‌ها:**
- علی: 66.67% (10/15)
- حسن: 33.33% (5/15)

### مرحله 2: فروش‌ها و سودها
**فروش 1 (15 فروردین 1403):**
- سود اولیه: 3 میلیون تومان
- سهم علی: 2 میلیون (66.67%)
- سهم حسن: 1 میلیون (33.33%)

**قسط 1 (15 اردیبهشت 1403):**
- سود ماهانه: 800 هزار تومان
- سهم علی: 533 هزار (66.67%)
- سهم حسن: 267 هزار (33.33%)

### مرحله 3: ورود شریک جدید
**محمد وارد می‌شود (1 خرداد 1403):**
- سرمایه محمد: 15 میلیون تومان
- **مجموع سرمایه جدید**: 30 میلیون تومان

**سهم‌های جدید:**
- علی: 33.33% (10/30)
- حسن: 16.67% (5/30)
- محمد: 50% (15/30)

### مرحله 4: فروش‌ها بعد از ورود محمد
**فروش 2 (10 خرداد 1403):**
- سود اولیه: 2 میلیون تومان
- سهم علی: 667 هزار (33.33%)
- سهم حسن: 333 هزار (16.67%)
- سهم محمد: 1 میلیون (50%)

**قسط 2 (15 تیر 1403):**
- سود ماهانه: 600 هزار تومان
- سهم علی: 200 هزار (33.33%)
- سهم حسن: 100 هزار (16.67%)
- سهم محمد: 300 هزار (50%)

### مرحله 5: حذف حسن (1 مرداد 1403)
**حسن تصمیم می‌گیره از کسب و کار خارج بشه:**
- حسن غیرفعال می‌شه (Soft Delete)
- **مجموع سرمایه جدید**: 25 میلیون تومان (علی + محمد)

**سهم‌های جدید:**
- علی: 40% (10/25)
- محمد: 60% (15/25)

### مرحله 6: فروش‌ها بعد از خروج حسن
**فروش 3 (10 مرداد 1403):**
- سود اولیه: 1.5 میلیون تومان
- سهم علی: 600 هزار (40%)
- سهم محمد: 900 هزار (60%)
- سهم حسن: 0 (خارج شده)

## نتیجه نهایی

### سود کل علی:
- سود اولیه: 2,000,000 + 667,000 = 2,667,000 تومان
- سود ماهانه: 533,000 + 200,000 = 733,000 تومان
- **مجموع**: 3,400,000 تومان

### سود کل حسن (تا زمان خروج):
- سود اولیه: 1,000,000 + 333,000 = 1,333,000 تومان
- سود ماهانه: 267,000 + 100,000 = 367,000 تومان
- **مجموع**: 1,700,000 تومان (فقط تا زمان خروج)

### سود کل محمد:
- سود اولیه: 0 + 1,000,000 + 900,000 = 1,900,000 تومان
- سود ماهانه: 0 + 300,000 = 300,000 تومان
- **مجموع**: 2,200,000 تومان

### سود کل علی (نهایی):
- سود اولیه: 2,000,000 + 667,000 + 600,000 = 3,267,000 تومان
- سود ماهانه: 533,000 + 200,000 = 733,000 تومان
- **مجموع**: 4,000,000 تومان

## نکات مهم

1. **محمد هیچ سهمی از سودهای قبل از ورودش ندارد**
2. **حسن هیچ سهمی از سودهای بعد از خروجش ندارد**
3. **علی و حسن سهم کمتری از سودهای بعد از ورود محمد می‌گیرند**
4. **علی و محمد سهم بیشتری از سودهای بعد از خروج حسن می‌گیرند**
5. **مجموع سودها همیشه برابر کل سود تولید شده است**
6. **هر تغییر در ترکیب شرکا فقط روی سودهای آینده تأثیر می‌گذارد**
7. **حذف شریک به صورت Soft Delete انجام می‌شه تا تاریخچه حفظ بشه**

## پیاده‌سازی در کد

```typescript
// بازسازی تاریخچه شرکا شامل زمان ورود و خروج
const partnersAtDate = allPartners.filter(p => {
  const joinDate = new Date(p.createdAt);
  const deleteDate = p.deletedAt ? new Date(p.deletedAt) : null;
  
  return joinDate <= date && (!deleteDate || deleteDate > date);
});

// محاسبه سهم هر شریک در آن زمان
const shareAtSaleTime = partner.capital / totalCapitalAtSaleTime;
const profitShare = saleProfit * shareAtSaleTime;
```

## تغییرات فنی

### Backend:
- اضافه شدن فیلدهای `status` و `deleted_at` به جدول partners
- تغییر DELETE به Soft Delete (غیرفعال کردن)
- اضافه شدن endpoint `/api/partners/all` برای دریافت تمام شرکا

### Frontend:
- بازسازی تاریخچه شرکا در محاسبات
- استفاده از تمام شرکا (شامل غیرفعال‌ها) برای محاسبات گذشته
- حفظ دقت محاسبات حتی بعد از حذف شریک

این سیستم تضمین می‌کند که:
- ✅ شرکای جدید فقط از زمان ورودشان سود می‌گیرند
- ✅ شرکای حذف شده فقط تا زمان خروجشان سود می‌گیرند
- ✅ شرکای قدیمی حق خود را از سودهای قبلی حفظ می‌کنند
- ✅ محاسبات همیشه دقیق و منصفانه است
- ✅ تغییر در ترکیب شرکا فقط آینده را تحت تأثیر قرار می‌دهد
- ✅ تاریخچه کامل شرکا حفظ می‌شه