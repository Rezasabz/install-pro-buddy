# مثال عملی استفاده از سرمایه بر اساس زمان (اصلاح شده)

## سناریو واقعی:

### مرحله 1: شرکای اولیه (10 آذر 1403)
- **شریک A**: 30 میلیون تومان
- **شریک B**: 27 میلیون تومان
- **مجموع سرمایه**: 57 میلیون تومان

**سرمایه در دسترس:**
- شریک A: 30 میلیون
- شریک B: 27 میلیون

### مرحله 2: فروش اول (11 آذر 1403)
**خرید گوشی:** 56 میلیون تومان

**تقسیم هزینه خرید:**
- شریک A: 29.47 میلیون (52.63% از 56 میلیون)
- شریک B: 26.53 میلیون (47.37% از 56 میلیون)

**سرمایه در دسترس بعد از خرید:**
- شریک A: 0.53 میلیون (30 - 29.47)
- شریک B: 0.47 میلیون (27 - 26.53)
- **مجموع در دسترس**: 1 میلیون

### مرحله 3: ورود شریک سوم (21 آذر 1403)
**شریک C وارد می‌شود:** 30 میلیون تومان

**سرمایه در دسترس بعد از ورود شریک C:**
- شریک A: 0.53 میلیون (بدون تغییر - چون قبلاً استفاده شده)
- شریک B: 0.47 میلیون (بدون تغییر - چون قبلاً استفاده شده)
- شریک C: 30 میلیون (کامل در دسترس - هنوز استفاده نشده)
- **مجموع در دسترس**: 31 میلیون

### مرحله 4: فروش دوم (25 آذر 1403)
**خرید گوشی:** 20 میلیون تومان

**شرکای موجود در زمان خرید:**
- شریک A: 30 میلیون (سرمایه کل)
- شریک B: 27 میلیون (سرمایه کل)
- شریک C: 30 میلیون (سرمایه کل)
- **مجموع**: 87 میلیون

**تقسیم هزینه خرید:**
- شریک A: 6.90 میلیون (34.48% از 20 میلیون)
- شریک B: 6.21 میلیون (31.03% از 20 میلیون)
- شریک C: 6.89 میلیون (34.48% از 20 میلیون)

**سرمایه در دسترس بعد از خرید:**
- شریک A: 0 میلیون (0.53 - 6.90 → 0)
- شریک B: 0 میلیون (0.47 - 6.21 → 0)
- شریک C: 23.11 میلیون (30 - 6.89)
- **مجموع در دسترس**: 23.11 میلیون

### مرحله 5: حذف شریک C
**شریک C حذف می‌شود:**

**سرمایه در دسترس بعد از حذف:**
- شریک A: 0 میلیون (بدون تغییر)
- شریک B: 0 میلیون (بدون تغییر)
- **مجموع در دسترس**: 0 میلیون

**نکته مهم:** سرمایه استفاده شده شریک C (6.89 میلیون) همچنان در سیستم باقی می‌مونه و به شرکای دیگه منتقل نمی‌شه.

## نکات مهم:

### ✅ درست (پیاده‌سازی اصلاح شده):
1. **شریک C فقط از زمان ورودش سرمایه استفاده می‌کنه**
2. **فروش قبل از ورود شریک C فقط بین A و B تقسیم شده**
3. **فروش بعد از ورود شریک C بین هر سه نفر تقسیم می‌شه**
4. **حذف شریک C محاسبات قبلی رو تغییر نمی‌ده**
5. **سرمایه در دسترس بر اساس استفاده واقعی محاسبه می‌شه**

### ❌ اشتباه (پیاده‌سازی قبلی):
1. **سرمایه استفاده شده بین همه شرکای فعلی تقسیم می‌شد**
2. **شریک جدید سهمی از هزینه‌های قبل از ورودش می‌پرداخت**
3. **حذف شریک محاسبات قبلی رو بهم می‌ریخت**
4. **محاسبات منصفانه نبود**

## کد پیاده‌سازی:

```typescript
// محاسبه سرمایه استفاده شده بر اساس زمان
for (const sale of salesAfterJoin) {
  const partnersAtSaleTime = partnerHistory.get(sale.saleDate) || [];
  const totalCapitalAtSaleTime = partnersAtSaleTime.reduce((sum, p) => sum + p.capital, 0);
  
  if (totalCapitalAtSaleTime > 0) {
    const shareAtSaleTime = partner.capital / totalCapitalAtSaleTime;
    partnerUsedCapital += (sale.purchasePrice || 0) * shareAtSaleTime;
  }
}
```

## نتیجه:
حالا سیستم کاملاً منصفانه کار می‌کنه و هر شریک فقط از زمان ورودش سهم هزینه‌ها و سودها رو داره.